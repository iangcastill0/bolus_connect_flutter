# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**Bolus Connect** is a Flutter-based mobile application for diabetes management that helps users calculate insulin bolus doses based on their glucose levels, carbohydrate intake, and CGM trend arrows. The app integrates with Firebase for authentication and uses OpenAI for AI-powered features.

## Development Commands

### Running the App
```bash
# Run on connected device or simulator
flutter run

# Run on specific device
flutter run -d <device-id>

# Run in release mode
flutter run --release
```

### Building
```bash
# Build for iOS
flutter build ios

# Build for Android
flutter build apk
flutter build appbundle

# Deploy iOS to TestFlight (from ios/ directory)
cd ios && bundle exec fastlane ios beta
```

### Testing & Linting
```bash
# Run tests
flutter test

# Analyze code for issues
flutter analyze

# Format code
flutter format lib/ test/
```

### Dependencies
```bash
# Get/update dependencies
flutter pub get

# Upgrade dependencies
flutter pub upgrade

# Clean build artifacts
flutter clean
```

## Architecture

### Application Flow
1. **Authentication Gate** (`lib/screens/auth_gate.dart`): Entry point that checks Firebase auth state and disclaimer acceptance
   - Unauthenticated → `WelcomePage` → `DisclaimerPage` → `LoginPage`
   - Authenticated → `MainTabsPage` (main app)

2. **Main Navigation** (`lib/screens/main_tabs_page.dart`): Bottom navigation with 4 tabs
   - **Home**: Simple dashboard showing user email
   - **Insights**: Bolus log history with analytics
   - **Bolus**: Core calculator for insulin dosing
   - **Settings**: User profile, parameters, and account management

3. **Health Profile Flow**: First-time users are prompted with a health questionnaire on login
   - Answers stored locally via `HealthQuestionnaireService`
   - Synced to backend (if `HEALTH_PROFILE_ENDPOINT` env var is set) via `HealthProfileSyncService`
   - Prompts user to configure bolus parameters after profile completion

### Key Services

#### `BolusLogService` (`lib/services/bolus_log_service.dart`)
- Manages local storage of bolus calculations using SharedPreferences
- Stores up to 100 entries with timestamps, glucose, carbs, calculated doses, and notes
- Entries are JSON-encoded and stored as a list of strings

#### `OpenAIClient` (`lib/services/openai_client.dart`)
- Wrapper for OpenAI Chat Completions API
- Default model: `gpt-4o-mini` with temperature 0.2
- Used for future AI-powered features (nutritional analysis, etc.)

#### `HealthQuestionnaireService` (`lib/services/health_questionnaire_service.dart`)
- Stores health questionnaire answers per user ID in SharedPreferences
- Tracks sync status with `lastSyncedAt` timestamp
- Supports multi-user data (keyed by Firebase UID)

#### `HealthProfileSyncService` (`lib/services/health_profile_sync_service.dart`)
- Syncs health profile to backend endpoint (configured via `HEALTH_PROFILE_ENDPOINT` compile-time constant)
- Uses Firebase ID token for authentication
- Fails gracefully if endpoint not configured (debug-only logging)

### Bolus Calculation Logic
Located in `lib/screens/bolus_page.dart`, the core calculation:

1. **Carb Bolus**: `carbs / icRatio`
2. **Correction Bolus**: `(currentGlucose - targetGlucose) / ISF`
3. **Trend Adjustment**: Based on CGM arrow (e.g., ↑↑, ↑, →, ↓, ↓↓)
   - Dexcom: 7 arrows (↑↑ to ↓↓)
   - Freestyle Libre: 5 arrows (↑ to ↓)
   - User-configurable units per arrow (defaults: ±1.0 for steep, ±0.5 for diagonal, 0.0 for flat)
4. **Total**: `carbBolus + correctionBolus + trendAdjustment`, clamped to ≥0 and rounded to 0.1U

Parameters (I:C ratio, target glucose, ISF) are stored in SharedPreferences and managed via `BolusParametersPage`.

### State Management
- **No formal state management library** (Provider, Riverpod, etc.)
- Uses `StatefulWidget` with `setState()` for local state
- `ValueNotifier` for cross-widget refresh triggers (e.g., `_bolusRefreshTick`, `_logsRefreshTick`)
- GlobalKey for triggering refreshes in specific pages (e.g., `_settingsPageKey`)

### Data Persistence
All user data stored locally using:
- **SharedPreferences**: Bolus parameters, questionnaire answers, logs
- **flutter_secure_storage**: OpenAI API key (stored securely)
- **Firebase Auth**: User sessions persist automatically (local storage on web, keychain on iOS/Android)

### Firebase Integration
- Authentication via Firebase Auth (email/password)
- `firebase_options.dart` auto-generated by FlutterFire CLI
- Web persistence set to `Persistence.LOCAL` in `main.dart`

## File Structure Highlights

```
lib/
├── main.dart                        # App entry point, Firebase init, routes
├── firebase_options.dart            # Firebase platform-specific config
├── screens/
│   ├── auth_gate.dart               # Auth state + onboarding router
│   ├── main_tabs_page.dart          # Bottom nav scaffold
│   ├── bolus_page.dart              # Core insulin calculator
│   ├── bolus_parameters_page.dart   # I:C, ISF, target glucose settings
│   ├── logs_page.dart               # Bolus history/insights
│   ├── settings_page.dart           # Profile, account, logout
│   ├── health_questionnaire_dialog.dart  # Health profile form
│   ├── welcome_page.dart            # Onboarding intro
│   ├── disclaimer_page.dart         # Legal disclaimer
│   ├── login_page.dart              # Firebase auth UI
│   └── home_page.dart               # Simple home dashboard
├── services/
│   ├── bolus_log_service.dart       # Local bolus history storage
│   ├── openai_client.dart           # OpenAI API wrapper
│   ├── health_questionnaire_service.dart   # Questionnaire storage
│   └── health_profile_sync_service.dart    # Backend sync
└── widgets/
    └── keyboard_dismissible.dart    # Tap-to-dismiss keyboard wrapper
```

## Environment Variables

Set at compile time using `--dart-define`:

- `HEALTH_PROFILE_ENDPOINT`: Backend URL for syncing health profiles
  ```bash
  flutter run --dart-define=HEALTH_PROFILE_ENDPOINT=https://api.example.com/profile
  ```

## Platform-Specific Notes

### iOS
- Uses Fastlane for TestFlight deployment
- Run from `ios/` directory: `bundle exec fastlane ios beta`
- Requires Xcode and valid provisioning profiles

### Android
- Firebase configuration in `android/app/google-services.json`
- Minimum SDK version and other config in `android/app/build.gradle`

### Web
- Firebase persistence set to `LOCAL` for session management
- Test locally: `flutter run -d chrome`

## Common Patterns

### Adding a New Screen
1. Create file in `lib/screens/`
2. Add route in `main.dart` routes map
3. Navigate via `Navigator.pushNamed(context, '/route-name')`

### Storing User Preferences
Use SharedPreferences for simple key-value storage:
```dart
final prefs = await SharedPreferences.getInstance();
await prefs.setString('key', 'value');
final value = prefs.getString('key');
```

### Refreshing Another Tab
Use `ValueNotifier<int>` pattern:
```dart
// In parent:
final _refreshTick = ValueNotifier<int>(0);
ChildWidget(refreshTick: _refreshTick);
// Trigger refresh:
_refreshTick.value++;

// In child:
widget.refreshTick?.addListener(_reload);
```

### Secure API Key Storage
```dart
import 'package:flutter_secure_storage/flutter_secure_storage.dart';
const storage = FlutterSecureStorage();
await storage.write(key: 'openai_api_key', value: apiKey);
final apiKey = await storage.read(key: 'openai_api_key');
```

## Important Considerations

- **Medical Disclaimer**: This app is for **educational use only**. All calculations should be reviewed with a healthcare provider. The disclaimer must be accepted before use.
- **Unit Precision**: Bolus doses rounded to 0.1U for safety and common pump precision
- **Glucose Units**: Supports both mg/dL and mmol/L (converted to mg/dL internally: `mmol/L * 18.0`)
- **CGM Manufacturer**: Trend arrows differ between Dexcom (7 arrows) and Freestyle Libre (5 arrows)
- **Offline-First**: All core functionality works offline; backend sync is optional

## Troubleshooting

### Firebase Not Initialized
- Ensure `firebase_options.dart` exists (run `flutterfire configure`)
- Check `google-services.json` (Android) / `GoogleService-Info.plist` (iOS) are present

### Bolus Parameters Not Saving
- Check SharedPreferences keys: `icRatio`, `targetGlucose`, `isf`, `glucoseUnit`
- Verify numeric parsing handles both `.` and `,` as decimal separators

### Health Profile Not Syncing
- Verify `HEALTH_PROFILE_ENDPOINT` is set at compile time
- Check debug logs for sync failures (network issues, auth token problems)
- Backend must accept `PUT` requests with `Authorization: Bearer <idToken>` header
